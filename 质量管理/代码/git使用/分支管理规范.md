# 分支管理规范



## 概述



### 分支的意义

分支管理是 git 使用中比重非常大的部分。正如分支的字面含义那样，只要在内容的演进过程中出现：

- 需要暂时离开干线
- 存在多条支线中，无法简单地选择一条作为干线

这类情况时，就需要用到分支。

经常存在这样一种看法：“单人开发维护的项目不需要引入分支”。这是非常片面的。

举例来说，在需要同时开发多个互不依赖的功能时，通过分支来隔离变动就非常必要。



### 分支管理的目的

根据经验，绝大多数的分支不会一直存在，它们终将在某个时间点回归干线。

另一方面，干线也是一个相对概念，某个干线也可能是另一条线上的分支。

因此我们面临的终极问题始终是如何降低分支回归干线的难度，这就是分支管理的目的。

在此基础上将我们要做的事情具体化，就是从开启分支起，让每一步操作符合一些有益的约束。



## 针对分支的操作规范

### 命名

命名是开启分支的第一步。在这里，我们更多关注每个协作者的个人维护的分支如开发分支。暂时不去讨论那些团队共同维护的分支如 `master` `develop` 之流，以及为满足团队工作流程而设计出来的固有分支，如`test/*` 或 `release/*` 之类。

个人维护分支应当按照 `类型/开发者/简述` 这样的格式来命名。

- 类型：应当标示出本分支的基本功能或用途

  类型的具体划分和语义，我们可以参考 [commit-message风格规范-格式-类型](./commit-message风格规范.md#类型) 中的定义

- 开发者：应当使用开发者在团队内为人熟知的名称或代号

- 简述：以简洁明了的文字表达出本次开启分支希望达成的目标



关于命名存在以下常见的疑问：

#### 问：是否可以省略 `开发者` 部分

答：当然可以省略，但是我们还是坚持加上这一部分，原因是，在非常多的环节中，分支名都会以一种比较显眼的方式出现，这有助于我们快速确认应当向谁去了解相关的信息，比如：

- 为什么要开这个分支
- 为什么分支这么久都没有动静
- 能不能清理掉

等。

此外，加上 `开发者`部分还有助于避免一批有着相近的命名习惯的开发者在同一时段内提交了带有容易混淆的名称的分支。

当然，如果你的代号容易和其他人混淆，那么可能你需要选一个更加“独特”的。



#### 问：为什么 `类型` 在 `开发者` 之前

答：没有特别突出的理由，但通常来说，我们更关注“现在哪些事件在进行中”，而不那么关注“现在哪些人在做事”。



#### 问：是否会出现分支中只有一条 message 与分支名长得很像的 commit 的情况

答：当然！这不但不成为一种问题，甚至是一种非常不错的实践，理由如下：

- 相对来说，commit message 会更长久地出现在主线中，而分支名只会保持一段时间。

  因此，分支名和 commit message 长得很像并不会困扰团队，或阅读代码的人。

- 能做到这样的程度，说明团队成员在管理 pr 的粒度、commit 的粒度方面达成了不错的效果。



### 常见操作

我们建议每一个使用者从 [Git Pro Book - 3.1 Git 分支 - 分支简介](https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E7%AE%80%E4%BB%8B)  开始，了解分支管理的基本概念和常见命令。

在了解以上内容的基础上，我们认为以下操作方式是开发者应当理解和熟练掌握的：

- branch
  - 本地
    - 创建
      - `git branch <name>` 和 `git checkout -b <name>` 的关系
    - 删除
  - 远程
    - 推送
      - 将本地分支以另一个名称推送到远程
    - 拉取
      - `git pull` 和 `git fetch` 的关系
    - 跟踪分支
    - 删除
  - 内容管理
    - `git commit`
    - `git reset`
    - `git merge`
    - `git rebase`
    - `git rebase -i`
    - `git cherry-pick`
    - `git rebase` 与 `git cherry-pick` 的关系
    - `git rebase` 与 `git commit --amend` 的异同
- tag
  - 本地
    - 创建
    - 删除
  - 远程
    - 创建
    - 删除
- remote
  - 添加
  - 重命名
  - 多 remote 管理
    - fork & contribute
      - 代码同步
      - 基于 fork 的 pr





## 基于分支的协作规范

1. 重要的、多人维护的分支必须处于物理保护之下，任何无法直接拒绝危险操作的保护形式都应当视为不可长久执行的。

2. 基于分支开启-合并的开发模式不仅限于对主分支，任何情况下，需要协作或交替工作时，都应当首先考虑使用这一模式。

3. 个人维护分支：

   1. 命名必须符合命名规范

   2. 维护分支的过程中，应当遵循 commit 管理的规范

      - 应当令一个 commit 包含的变动尽可能内敛

      - 应当执行 [commit-message风格规范](./commit-message风格规范.md)

      - 在需要中断当前工作时，可以采取一些临时措施，如

        - 使用 `git stash` 之类的方式留存未提交的变动
        - 进行一次 temp 提交，并推送到远程

        但要在重新开始工作后清除这种临时行为的痕迹

   3. 在提交给他人审阅之前，开发者应当：

      - 对 commits 进行规整
      - 解决与目标分支存在的冲突
      - 规整和解决冲突应当优先考虑使用 `rebase` 系列操作

4. 基于 3)，开发者应当在充分理解 `force-push` 的用途和危险性的情况下，做好本地工作内容和远程分支的同步

